# External Audit Plan

## Objective and Scope
The audit engagement covers the full AGI Jobs v2 protocol, its operator tooling, and the
supporting monitoring infrastructure. Auditors are expected to review:

- **Smart contracts** in `contracts/v2` and migration scripts in `migrations` and `scripts/v2`.
- **Operational tooling** that configures and supervises on-chain components (owner control,
  pause guardians, telemetry, and registry management scripts).
- **Interface and orchestration services** that exercise the contracts (agent gateway,
  orchestrator, attestation services, and CLI tooling).
- **Security configuration** (branch protection, CI checks, SBOM, dependency audit) to confirm
  that delivery pipelines are tamper resistant.

The deliverable for auditors is a frozen, reproducible repository snapshot together with the
artefacts listed below.

## Code Freeze Protocol
1. **Declare the freeze window** in the release channel and tag the commit that will be reviewed
   (`git tag audit-freeze-<date>`). Merge queues are paused and only emergency hotfix PRs are
   permitted.
2. **Lock branch protection** using `npm run ci:verify-branch-protection` and export the
   resulting report to `reports/audit/branch-protection.json`.
3. **Archive CI configuration** by copying `.github/workflows` and
   `docs/v2-ci-operations.md` into the dossier directory (see below).
4. **Verify dependency integrity** with `npm run ci:verify-toolchain` and
   `npm run security:audit`. Store the command logs.
5. **Confirm deployment immutability** by running `npm run owner:verify-control` and capturing
   the resulting Merkle tree digest for multisig and pause guardian assignments.
6. Record the freeze status in `docs/release-artifacts.md` with a short note pointing back to the
   audit tag.

## Audit Dossier Contents
The `reports/audit/<timestamp>` folder assembled via `tools/audit/prepare_dossier.sh` must include:

| Artefact | Source | Purpose |
| --- | --- | --- |
| Contract build outputs | `artifacts/` and `deployments/` | Allows auditors to diff bytecode and ABIs. |
| Deployment manifests | `docs/release-manifest.md`, `docs/deployment-summary.json` | Verify addresses and parameters. |
| Coverage report | Generated by `npm run coverage:report` | Demonstrates unit and integration test breadth. |
| Fuzzing summary | Latest run from `npm run echidna` and `foundry` snapshots | Shows property-based guarantees. |
| Static analysis results | `npm run lint:ci`, `npm run format:check`, `npm run security:audit`, `npm run ci:verify-signers` | Confirms coding standards and signer lists. |
| Scenario logs | Exported outputs of `scripts/v2/ownerControlDoctor.ts`, `scripts/v2/ownerEmergencyRunbook.ts`, `scripts/observability-smoke-check.js` | Evidence that operational runbooks succeed end-to-end. |
| Governance controls | Output of `npm run owner:parameters` and `npm run owner:command-center` | Documents live parameters and change capabilities. |
| Testnet rehearsal transcript | Logs collected during the dry-run deployment and execution flows. |

Each artefact is accompanied by a checksum manifest to ensure integrity when sharing with the
external firm.

## Preparing the Dossier (Automation)
A helper script is available at `tools/audit/prepare_dossier.sh`. The script performs the following
steps and writes results beneath `reports/audit/<timestamp>`:

1. Creates a dedicated directory and manifest file.
2. Runs deterministic verification commands (lint, formatting, access control, ABI diff checks).
3. Generates coverage reports and copies them into the dossier.
4. Invokes owner-control health checks to capture live configuration baselines.
5. Summarises command exit codes in `summary.json` for quick reference.

> **Note:** Commands that depend on private credentials or external infrastructure are executed with
> `SKIP_REMOTE=1` by default to avoid requiring secrets. Re-run them manually with the relevant
> environment configured if auditors request full external verification.

## Supporting Auditors & Remediation Workflow
- **Point of contact:** The Owner Control Team lead monitors the audit channel and acknowledges
  questions within one business hour.
- **Finding triage:** All reported issues are logged in `reports/audit/findings.md` with severity,
  owner, remediation plan, and completion timestamp. Hotfix branches follow the same CI gates as
  mainline commits.
- **Regression protection:** Every fix includes unit tests, coverage delta review, and updated
  documentation. Execute `npm run coverage:check` and `npm run check:access-control` before
  requesting re-validation from the auditors.

## Formal Verification Track (Optional)
Where resourcing allows, run Scribble/Verx or a Certora specification on the invariants listed in
`docs/invariants.md`. Store specifications and solver outputs inside the audit dossier so auditors
have immediate access.

## Testnet Deployment Dry-Run
After auditor sign-off and remediation, conduct a rehearsal on Sepolia:

1. Deploy contracts with `npm run migrate:sepolia`.
2. Execute operational scripts in order:
   - `npm run owner:plan:safe`
   - `npm run owner:doctor`
   - `npm run owner:emergency`
   - `npm run observability:smoke`
3. Trigger job lifecycle flows using the CLI and record transaction hashes in
   `reports/audit/testnet-run.log`.
4. Compare outputs against the audit test vectors and store the reconciliation notes.

## Post-Audit Hardening Checklist
- Re-run `npm run security:audit` and `npm run ci:verify-toolchain` to ensure patched dependencies
  remain clean.
- Update monitoring thresholds via `npm run monitoring:validate` and confirm the pause guardian can
  still respond within SLA using `npm run pause:test`.
- Sync the updated runbooks (for example `docs/owner-control-operations.md` and
  `docs/owner-control-emergency-runbook.md`) with any process changes identified during the audit.
- Remove the audit freeze tag only after all checklist items report âœ….

## Sharing Package with Auditors
Compress the dossier directory together with this document:

```bash
tar -czf agijobs-v2-audit-dossier.tar.gz docs/external-audit-plan.md reports/audit/<timestamp>
```

Provide the SHA-256 checksum separately and use the secure channel agreed with the auditor for
handover.
