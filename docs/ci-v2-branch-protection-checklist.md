# CI v2 Branch Protection Checklist

This checklist keeps the `main` branch locked to the `ci (v2)` signal deck and its
companion workflows. Run through it whenever new jobs are added or the GitHub rule-set
changes.

## Prerequisites

- Personal access token with `repo` and `admin:repo_hook` scopes for GitHubâ€™s GraphQL API.
- Local environment with Node.js 20.19.0 and the repository dependencies installed via
  `npm ci`.
- Up-to-date manifests in `ci/required-contexts.json` and
  `ci/required-companion-contexts.json` generated by `npm run ci:sync-contexts`.

## Enforcement steps

1. **Sync manifests from the workflow graph.**
   ```bash
   npm run ci:sync-contexts
   ```
   The script reads `.github/workflows/ci.yml` and companion workflows, writing both JSON
   manifests and failing if they drift.

2. **Apply the branch protection rule.**
   ```bash
   npm run ci:enforce-branch-protection -- --branch main --token <ghp_...>
   ```
   The enforcement script reads the manifests, derives the owner/repo from the git remote,
   and either updates or creates a rule that requires strict checks and admin compliance.
   Pass `--dry-run` to inspect the GraphQL payload without mutating GitHub.

3. **Audit the resulting rule.**
   ```bash
   npm run ci:verify-branch-protection -- --branch main
   ```
   This validation command emits a status table showing missing contexts, strictness, and
   admin enforcement. The same logic powers the `branch_protection` job inside
   `ci (v2)`, so a successful run here guarantees the workflow will stay green on
   trusted branches.

4. **Run the pipeline once.**
   Trigger the workflow (push or manual dispatch) and confirm the `CI summary` job reports
   every required context. The summary step fails if any artefact or job result is
   missing, leaving a Markdown/JSON bundle for compliance archives.

5. **Export the status bundle.**
   Download the `ci-summary` artefact from the run and store it alongside the change
   ticket. It lists each job, conclusion, and URL so auditors can reconstruct the run
   without hitting GitHub.

## Troubleshooting

- Use `npm run ci:verify-contexts` to detect when a renamed job or workflow has drifted
  from the manifest.
- If branch protection fails to update, re-run the enforcement step with `DEBUG` enabled to
  log the outgoing payload:
  ```bash
  DEBUG=workflow npm run ci:enforce-branch-protection -- --branch main --token <ghp_...>
  ```
- When adding new jobs, update the manifests and regenerate any downstream dashboards that
  consume `reports/ci/status.json`.
