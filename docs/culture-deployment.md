# Culture deployment & orchestration

This guide explains how to deploy the **CultureRegistry** and **SelfPlayArena**, seed the
system with sample agents and artifacts, and run a sanity-check arena round. It also
describes the configuration layout, secret management expectations, and optional
hardware-wallet flows.

## Prerequisites

- Node.js 20.18.1 (matching the repository engines requirement)
- Hardhat toolchain (`npm install` from the repo root)
- Network access to the target chain RPC endpoint specified in `config/culture.json`
- Access to the IdentityRegistry, JobRegistry, StakeManager, and FeePool addresses

## Configuration (`config/culture.json`)

Key sections of the configuration file:

| Section | Purpose |
| --- | --- |
| `owner` | Declares the owner account that will administer CultureRegistry and SelfPlayArena. |
| `dependencies` | Provides on-chain addresses for IdentityRegistry, JobRegistry, StakeManager, and FeePool. The deploy script wires these dependencies and records the new CultureRegistry/SelfPlayArena addresses after deployment. |
| `culture` | Sets allowed artifact kinds and the citation fan-out limit used during deployment. |
| `arena` | Defines the base economic parameters for SelfPlayArena (rewards, committee size, validator stake, and target success rate). |
| `seed` | Describes additional agents/validators, optional profile metadata, demo artifacts to mint, and the FeePool funding plan executed by the seeding script. |
| `sampleRound` | Supplies teacher, student, and validator addresses/job IDs for the sample arena run. The `mode` flag switches between stubbed and on-chain execution. |

After running `scripts/deploy.culture.ts`, the file is automatically updated with the
new contract addresses. The seeding script records minted artifact IDs back into the
same configuration file.

## Secret management

All scripts load secrets via [`dotenv`](https://github.com/motdotla/dotenv) and also support
HashiCorp Vault out of the box. The following environment variables are recognised:

| Variable | Usage |
| --- | --- |
| `CULTURE_DEPLOYER_KEY` / `CULTURE_DEPLOYER_VAULT_PATH` | Private key (or Vault path) for the account deploying CultureRegistry & SelfPlayArena. |
| `CULTURE_OWNER_KEY` / `CULTURE_OWNER_VAULT_PATH` | Owner account authorised to seed agents, mint artifacts, and manage SelfPlayArena roles. |
| `CULTURE_FEEPOOL_FUNDING_KEY` / `CULTURE_FEEPOOL_FUNDING_VAULT_PATH` | Account supplying tokens for FeePool contributions during seeding. Defaults to the owner key when not provided. |
| `CULTURE_ORCHESTRATOR_KEY` / `CULTURE_ORCHESTRATOR_VAULT_PATH` | Operator account executing the arena sanity check in on-chain mode. |
| `CULTURE_ARENA_MODE` | Optional override (`stub` or `onchain`) for the arena sample script. |
| `VAULT_ADDR`, `VAULT_TOKEN` | Connection details for HashiCorp Vault when using `*_VAULT_PATH` variables. |

Populate these variables in a local `.env` file or export them in the shell prior to
running the scripts. When using Vault, store the private key under the configured path
with a `privateKey` field; the helper will fetch and normalise it automatically.

## Hardware wallet guidance

For production deployments, prefer hardware-backed custody for the owner and funding
accounts. Recommended flow:

1. Use a Ledger / Trezor (or a Safe with hardware signers) to hold the owner key.
2. Export transactions generated by Hardhat using the `--network` flag and sign them
   via the hardware wallet UI or Safe transaction builder.
3. Provide a read-only RPC endpoint and set `HARDHAT_NETWORK` to the desired chain.
4. When running the scripts, omit `CULTURE_*_KEY` environment variables so the scripts
   fall back to the connected hardware wallet provider (e.g., use Hardhatâ€™s Ledger
   plugin or forward requests through a Safe service). The scripts will warn if they
   have to fall back to in-memory Hardhat accounts.

Document signed transaction hashes and keep hardware devices physically secured after
execution. Refer to `docs/production/nontechnical-mainnet-deployment.md` for broader
operational guidance on hardware wallets.

## Running the scripts

You can trigger the workflow via `npm` or the convenience Makefile targets.

### Using npm

```bash
# Deploy contracts (HARDHAT_NETWORK determines the target chain)
HARDHAT_NETWORK=anvil npm run culture:deploy

# Seed agents, artifacts, and fund the FeePool
HARDHAT_NETWORK=anvil npm run culture:seed

# Run the arena sanity check (set CULTURE_ARENA_MODE=onchain for live execution)
CULTURE_ARENA_MODE=stub npm run culture:arena:sample

# Chain everything together
HARDHAT_NETWORK=anvil npm run culture:bootstrap
```

### Using Makefile targets

```bash
# Deploy, seed, and run the stubbed arena round in one command
make culture-bootstrap NETWORK=anvil

# Execute only the arena round in on-chain mode
make culture-arena-sample MODE=onchain
```

Both approaches update `config/culture.json` to reflect deployed addresses and
minted artifact identifiers. Inspect the terminal output for verification messages,
including contract bytecode checks and emitted events.

## Verification and observability

- Deployment logs confirm bytecode presence for dependencies and new contracts.
- Hardhat verification runs automatically; if the contract is already verified the
  script logs an informational message.
- Seeding logs confirm IdentityRegistry role updates, artifact mint events, and
  FeePool contributions.
- The arena run highlights emitted events (`RoundStarted`, `RewardsDistributed`) and
  prints a round summary so you can cross-check on-chain state or indexing pipelines.
