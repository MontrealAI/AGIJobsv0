# Sentinel Guardrail Service

The sentinel service watches economic and reliability telemetry generated by the
HGM orchestrator and applies hard guardrails before expensive work escapes into
the wild. It continuously evaluates configured rules and toggles the engine and
workflow at runtime by:

- pausing further expansions when ROI drops below the configured floor for a
  sustained number of windows,
- halting expansions and signalling the orchestrator to stop once budget caps are
  consumed, and
- pruning agents that accrue repeated failures to prevent runaway spend on
  unhealthy clades.

## Configuration

Configuration lives in [`config/sentinel.json`](../../config/sentinel.json) and
is loaded by `services.sentinel.load_config()`. It supports environment override
via `SENTINEL_CONFIG` or `SENTINEL_CONFIG_PATH` if bespoke deployments need a
separate rule set. Key knobs include:

| Field | Purpose |
| ----- | ------- |
| `roiFloor` | Minimum acceptable ROI multiplier before the sentinel pauses expansions. |
| `roiGracePeriod` | Number of consecutive breaches required before a pause is enforced. |
| `budgetCap` / `budgetSoftRatio` | Hard and soft limits for total spend. The soft ratio gates expansions, while the hard cap raises a stop signal. |
| `failureStreak.threshold` | Consecutive failed evaluations that trigger agent pruning. |
| `successThreshold` | Reward threshold used to infer success when tasks omit an explicit `success` flag. |
| `monitorIntervalSeconds` | Maximum idle time before the monitor re-evaluates rules. |
| `alertChannels` | Channels used for asynchronous alert emission (currently logged to `monitoring/sentinel-alerts.log`). |

Any edits to the JSON file or environment overrides are picked up automatically
when a workflow constructs the sentinel monitor.

## Runtime Hooks & Overrides

`HGMOrchestrationWorkflow` wires the sentinel into critical decision points:

- `schedule_expansion` refuses new expansions when the sentinel has paused
  growth or requested a full stop.
- `schedule_evaluation` avoids work on pruned agents and respects global stop
  signals.
- Engine-level helpers (`set_expansion_gate`, `mark_pruned`, `is_pruned`) expose
  the guardrail state to other services such as dashboards.

Operators can override pauses by updating the JSON config (for example, raising
`roiFloor` or the `failureStreak` threshold) and recycling the workflow. The
monitor exposes `SentinelMonitor.snapshot()` for live observability and
`SentinelMonitor.close()` for shutdown hooks if a deployment needs to replace
rule sets without restarting the orchestrator.

## Alerting

Alerts are emitted asynchronously through `services.alerting.emit()` and
persisted to `monitoring/sentinel-alerts.log`. The default severity levels are:

- `warning` when ROI or soft budgets pause expansions,
- `critical` for budget cap halts and agent pruning, and
- `info` when the system automatically resumes after recovery.

Downstream monitoring stacks can tail the log file or wrap `services.alerting`
to forward alerts into existing observability pipelines.
