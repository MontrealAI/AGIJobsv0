<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phase 8 — Universal Value Dominance Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
    <style>
      :root {
        color-scheme: dark;
        --bg: radial-gradient(circle at top, rgba(45, 127, 220, 0.25), rgba(6, 12, 24, 0.95));
        --panel: rgba(15, 25, 55, 0.8);
        --panel-border: rgba(108, 192, 255, 0.35);
        --accent: #5ad2ff;
        --accent-strong: #ffa94d;
        --text: #e8f4ff;
        --muted: #9bbad8;
        --critical: #ff6b6b;
        --warning: #ffd43b;
        font-family: "Inter", system-ui, sans-serif;
        line-height: 1.6;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      a.skip-link {
        position: absolute;
        left: -999px;
        top: 1rem;
        background: var(--accent);
        color: #02101f;
        padding: 0.75rem 1.25rem;
        border-radius: 999px;
        font-weight: 600;
        text-decoration: none;
        z-index: 10;
      }

      a.skip-link:focus {
        left: 1rem;
      }

      header {
        padding: 4rem 1.5rem 2rem;
        text-align: center;
      }

      header h1 {
        margin: 0;
        font-size: clamp(2.5rem, 6vw, 4.5rem);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      header p {
        max-width: 720px;
        margin: 1rem auto 0;
        color: var(--muted);
        font-size: 1.1rem;
      }

      main {
        width: min(1120px, 95vw);
        margin: 0 auto 4rem;
        display: grid;
        gap: 2.5rem;
      }

      .alert-container {
        width: min(1120px, 95vw);
        margin: 0 auto 1.5rem;
        display: grid;
        gap: 1rem;
      }

      .error-panel {
        width: min(1120px, 95vw);
        margin: 0 auto 1.5rem;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 18px;
        border: 1px solid rgba(255, 107, 107, 0.35);
        padding: 1.75rem 2rem;
        box-shadow: 0 18px 40px rgba(5, 12, 22, 0.45);
        display: none;
      }

      .error-panel[data-state="visible"] {
        display: block;
      }

      .error-panel h2 {
        margin-top: 0;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--critical);
      }

      .error-panel ol {
        margin: 0.75rem 0 0;
        padding-left: 1.25rem;
        color: var(--muted);
        display: grid;
        gap: 0.35rem;
      }

      .error-panel a {
        color: var(--accent);
        font-weight: 600;
      }

      .error-panel .error-detail {
        margin: 0.5rem 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .alert {
        background: rgba(255, 255, 255, 0.04);
        border-left: 4px solid var(--accent);
        border-radius: 18px;
        padding: 1.25rem 1.75rem;
        box-shadow: 0 18px 40px rgba(5, 12, 22, 0.4);
      }

      .alert[data-level="critical"] {
        border-color: var(--critical);
      }

      .alert[data-level="warning"] {
        border-color: var(--warning);
      }

      .alert[data-level="success"] {
        border-color: var(--accent-strong);
      }

      .alert strong {
        display: block;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        margin-bottom: 0.35rem;
      }

      .alert p {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .manifest-console {
        width: min(1120px, 95vw);
        margin: 0 auto 2rem;
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        padding: 1.75rem 2rem;
        box-shadow: 0 22px 50px rgba(5, 12, 22, 0.5);
        display: grid;
        gap: 1.5rem;
      }

      .manifest-console__header {
        display: grid;
        gap: 0.75rem;
      }

      .manifest-console__header h2 {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 1rem;
        color: var(--muted);
      }

      .manifest-console__header p {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .manifest-console__status {
        margin: 0;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--accent);
      }

      .manifest-console__status[data-status="error"] {
        color: var(--critical);
      }

      .manifest-console__status[data-status="loading"] {
        color: var(--warning);
      }

      .manifest-console__grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .manifest-console__card {
        position: relative;
        background: rgba(20, 40, 72, 0.65);
        border: 1px solid rgba(108, 192, 255, 0.2);
        border-radius: 16px;
        padding: 1.25rem 1.5rem;
        box-shadow: inset 0 0 0 1px rgba(92, 150, 220, 0.08);
        display: grid;
        gap: 0.65rem;
      }

      .manifest-console__card-title {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .manifest-console__card-description,
      .manifest-console__helper {
        margin: 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .manifest-console__upload {
        cursor: pointer;
        overflow: hidden;
      }

      .manifest-console__upload input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .manifest-console__input-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .manifest-console__input-row input[type="url"] {
        flex: 1;
        padding: 0.65rem 0.85rem;
        border-radius: 999px;
        border: 1px solid rgba(108, 192, 255, 0.35);
        background: rgba(8, 20, 40, 0.75);
        color: var(--text);
        font-size: 0.95rem;
        outline: none;
      }

      .manifest-console__input-row input[type="url"]:focus-visible {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(90, 210, 255, 0.35);
      }

      .manifest-console__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .console-button {
        padding: 0.6rem 1.1rem;
        border-radius: 999px;
        border: 1px solid rgba(90, 210, 255, 0.45);
        background: linear-gradient(135deg, rgba(90, 210, 255, 0.25), rgba(90, 210, 255, 0.08));
        color: var(--text);
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: transform 150ms ease, box-shadow 150ms ease;
      }

      .console-button:hover,
      .console-button:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(25, 120, 215, 0.35);
        outline: none;
      }

      .console-button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      .manifest-console__feedback {
        margin: 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .manifest-console__feedback[data-visible="false"] {
        display: none;
      }

      .manifest-console__feedback[data-tone="success"] {
        color: #7ff5d0;
      }

      .manifest-console__feedback[data-tone="error"] {
        color: var(--critical);
      }

      .manifest-console__feedback[data-tone="warning"] {
        color: var(--warning);
      }

      .manifest-console__feedback[data-tone="info"] {
        color: var(--muted);
      }

      @media (max-width: 640px) {
        .manifest-console__input-row {
          flex-direction: column;
          align-items: stretch;
        }

        .console-button {
          width: 100%;
          text-align: center;
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
      }

      .stat-card {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        padding: 1.75rem;
        box-shadow: 0 18px 40px rgba(5, 12, 22, 0.4);
      }

      .stat-card h2 {
        margin: 0 0 0.6rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--muted);
      }

      .stat-card p {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        word-break: break-word;
      }

      section {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 24px;
        padding: 2.4rem;
        box-shadow: 0 22px 42px rgba(5, 12, 22, 0.35);
      }

      section h2 {
        margin: 0 0 1.5rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      .domain-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
      }

      .domain-card {
        border: 1px solid rgba(90, 210, 255, 0.4);
        border-radius: 20px;
        padding: 1.75rem;
        background: linear-gradient(135deg, rgba(16, 40, 76, 0.8), rgba(7, 14, 24, 0.92));
        display: grid;
        gap: 1rem;
      }

      .domain-card.no-coverage {
        border-color: rgba(255, 96, 110, 0.6);
        box-shadow: 0 0 0 1px rgba(255, 96, 110, 0.35);
      }

      .domain-card.no-coverage::after {
        content: "Sentinel coverage required";
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        background: rgba(255, 96, 110, 0.18);
        border: 1px solid rgba(255, 96, 110, 0.5);
        color: #ffccd3;
        width: fit-content;
      }

      .domain-card.no-funding {
        border-color: rgba(255, 212, 59, 0.6);
        box-shadow: 0 0 0 1px rgba(255, 212, 59, 0.3);
      }

      .domain-card h3 {
        margin: 0;
        font-size: 1.35rem;
      }

      .domain-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .chip {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        background: rgba(90, 210, 255, 0.12);
        border: 1px solid rgba(90, 210, 255, 0.35);
      }

      .chip.alt {
        background: rgba(255, 169, 77, 0.14);
        border-color: rgba(255, 169, 77, 0.5);
        color: #ffd9b0;
      }

      .chip.warning {
        background: rgba(255, 107, 107, 0.18);
        border-color: rgba(255, 107, 107, 0.4);
        color: #ffccd3;
      }

      .domain-warnings {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .sentinel-list,
      .stream-list,
      .playbook-list {
        display: grid;
        gap: 1rem;
      }

      .sentinel-item,
      .stream-item,
      .playbook-item {
        padding: 1.25rem;
        border-radius: 18px;
        border: 1px solid rgba(90, 210, 255, 0.25);
        background: rgba(12, 20, 38, 0.72);
      }

      .mermaid-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-bottom: 0.85rem;
      }

      .mermaid-actions[data-visible="false"] {
        display: none;
      }

      .mermaid-wrapper {
        background: rgba(12, 20, 38, 0.82);
        border-radius: 18px;
        padding: 1.25rem;
        border: 1px solid rgba(90, 210, 255, 0.2);
        overflow-x: auto;
      }

      .runbook-steps {
        display: grid;
        gap: 1rem;
        padding-left: 1.25rem;
      }

      .runbook-step {
        position: relative;
        display: grid;
        gap: 0.5rem;
        padding: 1.1rem 1.25rem;
        border-radius: 18px;
        border: 1px solid rgba(90, 210, 255, 0.25);
        background: rgba(12, 20, 38, 0.72);
      }

      .runbook-step[data-has-code="true"] {
        gap: 0.85rem;
      }

      .runbook-step-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem 1rem;
      }

      .info-button {
        appearance: none;
        border: none;
        background: rgba(90, 210, 255, 0.15);
        border-radius: 999px;
        color: var(--text);
        font-weight: 700;
        width: 1.85rem;
        height: 1.85rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .info-button:focus-visible,
      .download-link:focus-visible,
      a:focus-visible {
        outline: 3px solid var(--accent);
        outline-offset: 4px;
      }

      .copy-controls {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
      }

      .command-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem 1rem;
        align-items: center;
      }

      .command-row code {
        flex: 1 1 auto;
      }

      .copy-button {
        appearance: none;
        border: 1px solid rgba(90, 210, 255, 0.4);
        background: rgba(90, 210, 255, 0.12);
        color: var(--text);
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: background 150ms ease;
      }

      .copy-button:hover,
      .copy-button:focus-visible {
        background: rgba(90, 210, 255, 0.22);
      }

      .copy-button[data-copy-state="copied"] {
        background: rgba(90, 255, 180, 0.22);
        border-color: rgba(90, 255, 180, 0.4);
      }

      .copy-button[data-copy-state="error"] {
        background: rgba(255, 107, 107, 0.18);
        border-color: rgba(255, 107, 107, 0.45);
      }

      .copy-feedback {
        color: var(--muted);
        font-size: 0.78rem;
        min-height: 0.9rem;
        display: none;
      }

      .copy-feedback[data-visible="true"] {
        display: inline-block;
      }

      .control-card {
        display: grid;
        gap: 1rem;
      }

      .control-value {
        display: grid;
        gap: 0.35rem;
      }

      .control-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
      }

      .control-value-inner {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 0.75rem;
        align-items: center;
      }

      .control-value-text {
        font-family: "Inter", ui-monospace, SFMono-Regular, SFMono, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        letter-spacing: 0.02em;
      }

      .tooltip {
        position: absolute;
        inset-inline-start: 1.25rem;
        bottom: calc(100% + 0.75rem);
        max-width: min(320px, 80vw);
        padding: 0.65rem 0.9rem;
        border-radius: 12px;
        background: rgba(4, 10, 22, 0.92);
        border: 1px solid rgba(90, 210, 255, 0.35);
        box-shadow: 0 18px 30px rgba(5, 12, 22, 0.45);
        color: var(--muted);
        font-size: 0.85rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 150ms ease;
        z-index: 5;
      }

      .tooltip[data-visible="true"] {
        opacity: 1;
        visibility: visible;
      }

      .download-link {
        color: var(--accent);
        font-weight: 600;
        text-decoration: none;
      }

      footer {
        text-align: center;
        padding: 2rem 1.5rem 3rem;
        color: var(--muted);
        font-size: 0.9rem;
      }

      @media (max-width: 960px) {
        header {
          padding-top: 3.2rem;
        }

        section {
          padding: 2rem;
        }
      }

      @media (max-width: 600px) {
        header p {
          font-size: 1rem;
        }

        .runbook-step-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .tooltip {
          position: static;
          inset-inline-start: auto;
          bottom: auto;
        }

        .tooltip[data-visible="true"] {
          margin-top: 0.25rem;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to main content</a>
    <header>
      <h1 data-i18n-key="headings.hero">Phase 8 · Universal Value Dominance</h1>
      <p data-i18n-key="copy.hero">
        This console proves a non-technical operator can marshal a superintelligent, DAO-governed economy. Load the manifest,
        execute the suggested governance transactions, and watch AGI Jobs v0 (v2) orchestrate planetary-scale value with safe,
        transparent guardrails.
      </p>
    </header>
    <section class="manifest-console" aria-labelledby="manifest-console-heading" data-test-id="manifest-console">
      <div class="manifest-console__header">
        <h2 id="manifest-console-heading" data-i18n-key="manifestConsole.heading">Manifest command console</h2>
        <p data-i18n-key="manifestConsole.description">
          Drop in a new Phase 8 manifest or fetch one from a remote URL and the entire dashboard will reconfigure instantly — no rebuild, no redeploy.
        </p>
        <p
          class="manifest-console__status"
          data-manifest-status
          data-status="loading"
          aria-live="polite"
          data-i18n-key="manifestConsole.status.loading"
        >
          Loading manifest…
        </p>
      </div>
      <div class="manifest-console__grid">
        <label class="manifest-console__card manifest-console__upload" data-test-id="manifest-upload">
          <span
            class="manifest-console__card-title"
            id="manifest-upload-title"
            data-i18n-key="manifestConsole.uploadTitle"
          >
            Upload manifest
          </span>
          <span
            class="manifest-console__card-description"
            id="manifest-upload-hint"
            data-i18n-key="manifestConsole.uploadHint"
          >
            Click or drop a JSON manifest generated by AGI Jobs v0 (v2). The console will preview it instantly.
          </span>
          <input
            type="file"
            accept="application/json"
            id="manifest-upload-input"
            aria-labelledby="manifest-upload-title manifest-upload-hint"
            data-test-id="manifest-upload-input"
          />
        </label>
        <form
          class="manifest-console__card"
          id="manifest-url-form"
          data-test-id="manifest-url-form"
          novalidate
        >
          <span class="manifest-console__card-title" id="manifest-url-title" data-i18n-key="manifestConsole.urlTitle">
            Load from URL
          </span>
          <p class="sr-only" id="manifest-url-description" data-i18n-key="manifestConsole.urlDescription">
            Enter a URL that returns a Phase 8 manifest JSON. The dashboard will fetch and render it.
          </p>
          <div class="manifest-console__input-row">
            <input
              type="url"
              id="manifest-url-input"
              name="manifest-url"
              placeholder="https://example.com/manifest.json"
              aria-labelledby="manifest-url-title"
              aria-describedby="manifest-url-description manifest-url-hint"
              data-test-id="manifest-url-input"
            />
            <button
              type="submit"
              class="console-button"
              data-test-id="manifest-url-submit"
              data-i18n-key="manifestConsole.urlButton"
            >
              Load
            </button>
          </div>
          <p class="manifest-console__helper" id="manifest-url-hint" data-i18n-key="manifestConsole.urlHint">
            Supports HTTPS endpoints, IPFS gateways, or signed object storage with permissive CORS.
          </p>
        </form>
        <div class="manifest-console__card" data-test-id="manifest-session-card">
          <span class="manifest-console__card-title" data-i18n-key="manifestConsole.sessionTitle">
            Session controls
          </span>
          <div class="manifest-console__actions">
            <button
              type="button"
              class="console-button"
              id="manifest-reset"
              data-test-id="manifest-reset"
              data-i18n-key="manifestConsole.resetButton"
            >
              Use baseline manifest
            </button>
            <button
              type="button"
              class="console-button"
              id="manifest-refresh"
              data-test-id="manifest-refresh"
              data-i18n-key="manifestConsole.refreshButton"
            >
              Refetch baseline
            </button>
          </div>
          <p class="manifest-console__helper" data-i18n-key="manifestConsole.sessionHint">
            Snap back to the orchestrator’s manifest or pull a fresh copy from disk to sync with your repo.
          </p>
        </div>
      </div>
      <p
        class="manifest-console__feedback"
        data-manifest-feedback
        data-visible="false"
        aria-live="polite"
        data-i18n-key="manifestConsole.feedback.ready"
      ></p>
    </section>
    <section
      class="error-panel"
      id="error-panel"
      role="alert"
      aria-live="assertive"
      data-role="error-panel"
      data-test-id="error-panel"
      hidden
    ></section>
    <div class="alert-container" id="alerts" role="region" aria-live="polite"></div>
    <main id="main">
      <section aria-labelledby="stats-heading">
        <h2 id="stats-heading" data-i18n-key="headings.stats">Strategic Metrics</h2>
        <div class="stats-grid" id="stats" role="list"></div>
      </section>
      <section aria-labelledby="controls-heading">
        <h2 id="controls-heading" data-i18n-key="headings.controls">Governance Control Surface</h2>
        <div class="sentinel-list" id="controls"></div>
      </section>
      <section aria-labelledby="domains-heading">
        <h2 id="domains-heading" data-i18n-key="headings.domains">Dominion Registry</h2>
        <div class="domain-grid" id="domains"></div>
      </section>
      <section aria-labelledby="sentinels-heading">
        <h2 id="sentinels-heading" data-i18n-key="headings.sentinels">Sentinel Lattice</h2>
        <div class="sentinel-list" id="sentinels"></div>
      </section>
      <section aria-labelledby="streams-heading">
        <h2 id="streams-heading" data-i18n-key="headings.streams">Capital Streams</h2>
        <div class="stream-list" id="streams"></div>
      </section>
      <section aria-labelledby="playbooks-heading">
        <h2 id="playbooks-heading" data-i18n-key="headings.playbooks">Self-Improvement Kernel</h2>
        <div class="playbook-list" id="playbooks"></div>
      </section>
      <section aria-labelledby="mermaid-heading">
        <h2 id="mermaid-heading" data-i18n-key="headings.mermaid">Mermaid · Universal Value Mesh</h2>
        <div class="mermaid-actions" data-role="mermaid-controls" data-visible="false">
          <div class="copy-controls" data-role="mermaid-copy-controls"></div>
          <span
            class="copy-feedback"
            data-feedback-for="mermaid-diagram"
            data-test-id="copy-feedback"
            role="status"
            aria-live="polite"
          ></span>
        </div>
        <div class="mermaid-wrapper" aria-live="polite">
          <div class="mermaid" id="mermaid-diagram" data-test-id="mermaid-diagram">graph TD; Loading --> Manifest</div>
        </div>
      </section>
      <section aria-labelledby="runbook-heading">
        <h2 id="runbook-heading" data-i18n-key="headings.runbook">Operator Runbook</h2>
        <ol class="runbook-steps" id="runbook"></ol>
      </section>
    </main>
    <footer>
      <span>AGI Jobs v0 (v2) — Universal Value Dominance demo. Everything you need to command a trillion-dollar superintelligence.</span>
    </footer>
    <script type="module">
      let configPath = new URL("./config/universal.value.manifest.json", import.meta.url);
      const params = new URLSearchParams(window.location.search);
      const manifestOverride = params.get("manifest");
      let baselineSourceType = "default";
      if (manifestOverride) {
        try {
          configPath = new URL(manifestOverride, window.location.href);
          baselineSourceType = "param";
        } catch (error) {
          console.warn("Invalid ?manifest override", error);
        }
      }
      const baselineLabel =
        baselineSourceType === "default" ? "config/universal.value.manifest.json" : configPath.href;
      const dateFormatter = new Intl.DateTimeFormat("en-US", {
        dateStyle: "medium",
        timeStyle: "short",
        timeZone: "UTC",
      });

      const TEXT = {
        copy: {
          action: "Copy",
          ariaDefault: "Copy to clipboard",
          commandAria: "Copy command for step {step}",
          controlAria: "Copy value for {label}",
          diagramLabel: "Mermaid blueprint",
          diagramAria: "Copy Mermaid architecture to clipboard",
          success: "Copied to clipboard.",
          error: "Copy failed. Use manual copy.",
        },
        errors: {
          loadTitle: "Manifest unavailable",
          loadBody:
            "The Universal Value manifest could not be loaded from config/universal.value.manifest.json.",
          stepsIntro: "Troubleshooting steps",
          stepCheckPath:
            "Confirm the manifest file exists at demo/Phase-8-Universal-Value-Dominance/config/universal.value.manifest.json.",
          stepRebuild:
            "Regenerate the manifest with npm run demo:phase8:orchestrate so outputs and calldata stay in sync.",
          stepDocs: "Consult the dashboard operations guide for recovery playbooks.",
          docsLabel: "Open dashboard operations guide",
          docsHref: "../../docs/phase8-dashboard-operations.md",
        },
        runbook: {
          tooltipAria: "Show additional guidance for step {step}",
          steps: {
            install: {
              text: "Install dependencies once",
              tooltip:
                "Ensures deterministic installs for the orchestrator and demo console using the pinned lockfile.",
              copyLabel: "npm ci command",
            },
            orchestrate: {
              text: "Generate calldata + telemetry",
              tooltip: "Synthesizes Phase 8 governance transactions alongside telemetry bundles.",
              downloadLabel: "Download orchestration report",
              copyLabel: "phase8 orchestration command",
            },
            apply: {
              text: "Apply transactions via your governance Safe / Timelock",
              tooltip:
                "Stage and execute the generated calldata through your guardian-controlled Safe or timelock queue.",
            },
            plan: {
              text: "Update the self-improvement plan hash + cadence",
              tooltip:
                "Call the manager contract with the new cadence, plan hash, and plan URI produced by the orchestrator run.",
              downloadLabel: "Download latest plan payload",
              copyLabel: "Self-improvement plan command",
            },
            record: {
              text: "Record each improvement cycle and archive reports",
              tooltip: "Log every cycle execution and file the generated report URIs for auditability.",
              downloadLabel: "Download cycle report",
              copyLabel: "Cycle logging command",
            },
            telemetry: {
              text: "Stream live telemetry from this console and the orchestrator runtime",
              tooltip: "Pin the dashboards inside Mission Control to watch sentinel coverage and stream health in real-time.",
            },
            trigger: {
              text: "Trigger self-improvement playbooks as needed",
              tooltip: "Follow guardrails and escalation paths before invoking automation routines.",
            },
          },
        },
        controls: {
          treasury: "Treasury",
          vault: "Vault",
          upgradeCoordinator: "Upgrade coordinator",
          validatorRegistry: "Validator registry",
          missionControl: "Mission control",
          knowledgeGraph: "Knowledge graph",
          guardianCouncil: "Guardian council",
          systemPause: "System pause",
          manifest: "Manifest",
          drawdown: "Drawdown guard",
        },
        manifestConsole: {
          heading: "Manifest command console",
          description:
            "Drop in a new Phase 8 manifest or fetch one from a remote URL and the entire dashboard will reconfigure instantly.",
          uploadTitle: "Upload manifest",
          uploadHint: "Click or drop a JSON manifest generated by AGI Jobs v0 (v2). The console will preview it instantly.",
          urlTitle: "Load from URL",
          urlDescription: "Enter a manifest URL and the dashboard will fetch and render it.",
          urlHint: "Supports HTTPS endpoints, IPFS gateways, or signed object storage with permissive CORS.",
          urlButton: "Load",
          sessionTitle: "Session controls",
          sessionHint: "Return to the orchestrator output or refetch the baseline manifest from disk.",
          resetButton: "Use baseline manifest",
          refreshButton: "Refetch baseline",
          status: {
            loading: "Loading manifest…",
            default: "Active manifest: default — {path}",
            param: "Active manifest: query override — {url}",
            upload: "Active manifest: uploaded file — {name}",
            url: "Active manifest: remote manifest — {url}",
            custom: "Active manifest: custom manifest",
            error: "Manifest status unknown — review the last load attempt.",
          },
          feedback: {
            ready: "",
            successUpload: "Uploaded manifest applied to dashboard.",
            successUrl: "Remote manifest loaded successfully.",
            refresh: "Baseline manifest refreshed from disk.",
            reset: "Baseline manifest restored.",
            paramOverride: "Loaded manifest from ?manifest= override.",
            errorInvalidJson: "Manifest could not be parsed. Verify it matches the Phase 8 schema.",
            errorFetch: "Unable to load manifest from the provided source.",
            errorEmptyUrl: "Enter a manifest URL to load.",
            errorInvalidUrl: "The provided manifest URL is invalid.",
            errorUpload: "Manifest upload failed. Retry with a valid JSON file.",
          },
        },
        fallbacks: {
          missingManifest: "Manifest URI not provided.",
          noDominions: "No dominions configured.",
          autonomyPending: "Autonomy narrative pending.",
          coverageRequired: "Capital stream required",
          noSentinels: "No sentinels configured.",
          noStreams: "No capital streams configured.",
          noPlaybooks: "No self-improvement playbooks recorded yet.",
          playbookPending: "Playbook description pending.",
        },
        mermaid: {
          fallback: "Mermaid rendering fell back to text mode. Review console logs for diagram errors.",
        },
      };

      const copyButtonTimers = new WeakMap();

      const t = (key) =>
        key.split(".").reduce((value, segment) => {
          if (value && Object.prototype.hasOwnProperty.call(value, segment)) {
            return value[segment];
          }
          return undefined;
        }, TEXT) ?? key;

      const escapeHtml = (value) =>
        String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");

      const escapeSelector = (value) => {
        if (typeof CSS !== "undefined" && typeof CSS.escape === "function") {
          return CSS.escape(value);
        }
        return String(value ?? "").replace(/[^a-zA-Z0-9_-]/g, "\\$&");
      };

      const copyButtonMarkup = (payload, { ariaLabel, feedbackId, testId, copyLabel, type } = {}) => {
        if (!payload) return "";
        const encoded = encodeURIComponent(String(payload));
        const attributes = [
          'type="button"',
          'class="copy-button"',
          `data-copy-payload="${encoded}"`,
        ];
        if (feedbackId) {
          attributes.push(`data-feedback-id="${escapeHtml(feedbackId)}"`);
        }
        if (copyLabel) {
          attributes.push(`data-copy-label="${escapeHtml(copyLabel)}"`);
        }
        if (testId) {
          attributes.push(`data-test-id="${testId}"`);
        }
        if (type) {
          attributes.push(`data-copy-type="${escapeHtml(type)}"`);
        }
        const resolvedAria = escapeHtml(ariaLabel || t("copy.ariaDefault"));
        attributes.push(`aria-label="${resolvedAria}"`);
        return `<button ${attributes.join(" ")}>${t("copy.action")}</button>`;
      };

      const getCopyFeedback = (button) => {
        const id = button.dataset.feedbackId;
        if (!id) return undefined;
        return document.querySelector(`.copy-feedback[data-feedback-for="${escapeSelector(id)}"]`);
      };

      const resetCopyFeedback = (button, feedback) => {
        button.removeAttribute("data-copy-state");
        if (feedback) {
          feedback.textContent = "";
          feedback.removeAttribute("data-visible");
        }
      };

      const hideAllTooltips = (exception) => {
        document.querySelectorAll('.info-button[aria-controls]').forEach((btn) => {
          if (exception && btn === exception) return;
          const id = btn.getAttribute('aria-controls');
          if (!id) return;
          const tooltip = document.getElementById(id);
          if (tooltip) {
            tooltip.setAttribute('data-visible', 'false');
          }
          btn.setAttribute('aria-expanded', 'false');
        });
      };

      const toggleTooltip = (button, visible) => {
        const id = button.getAttribute('aria-controls');
        if (!id) return;
        const tooltip = document.getElementById(id);
        if (!tooltip) return;
        const next = visible ?? tooltip.getAttribute('data-visible') !== 'true';
        tooltip.setAttribute('data-visible', next ? 'true' : 'false');
        button.setAttribute('aria-expanded', next ? 'true' : 'false');
      };

      const writeToClipboard = async (value) => {
        if (!value) return false;
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(value);
            return true;
          }
        } catch (error) {
          console.warn('Clipboard API failed, falling back to execCommand', error);
        }
        try {
          const textArea = document.createElement('textarea');
          textArea.value = value;
          textArea.setAttribute('aria-hidden', 'true');
          textArea.style.position = 'fixed';
          textArea.style.opacity = '0';
          document.body.appendChild(textArea);
          textArea.select();
          const succeeded = document.execCommand('copy');
          document.body.removeChild(textArea);
          return succeeded;
        } catch (error) {
          console.warn('execCommand copy fallback failed', error);
          return false;
        }
      };

      const handleCopy = async (button) => {
        const payload = button.dataset.copyPayload ? decodeURIComponent(button.dataset.copyPayload) : "";
        if (!payload) return;
        const feedback = getCopyFeedback(button);
        if (copyButtonTimers.has(button)) {
          window.clearTimeout(copyButtonTimers.get(button));
        }
        const success = await writeToClipboard(payload);
        const label = button.dataset.copyLabel || "";
        button.setAttribute("data-copy-state", success ? "copied" : "error");
        if (feedback) {
          const template = success ? t("copy.success") : t("copy.error");
          const message = label ? `${template} ${label}` : template;
          feedback.textContent = message;
          feedback.setAttribute("data-visible", "true");
        }
        const timer = window.setTimeout(() => {
          resetCopyFeedback(button, feedback);
          copyButtonTimers.delete(button);
        }, success ? 3500 : 5500);
        copyButtonTimers.set(button, timer);
      };

      const mainContent = document.getElementById("main");
      const alertsRegion = document.getElementById("alerts");
      const errorPanel = document.querySelector('[data-role="error-panel"]');

      const clearErrorState = () => {
        if (errorPanel) {
          errorPanel.hidden = true;
          errorPanel.removeAttribute("data-state");
          errorPanel.innerHTML = "";
        }
        if (alertsRegion) {
          alertsRegion.removeAttribute("hidden");
        }
        if (mainContent) {
          mainContent.removeAttribute("hidden");
          mainContent.removeAttribute("aria-hidden");
        }
      };

      const showErrorPanel = ({ message, steps = [] } = {}) => {
        if (!errorPanel) return;
        const troubleshooting = steps.length
          ? `<h3 data-i18n-key="errors.stepsIntro">${t("errors.stepsIntro")}</h3>
             <ol>${steps.map((step) => `<li>${escapeHtml(step)}</li>`).join("")}</ol>`
          : "";
        const docsLink = TEXT.errors.docsHref
          ? `<p><a href="${TEXT.errors.docsHref}" data-i18n-key="errors.docsLabel">${t("errors.docsLabel")}</a></p>`
          : "";
        const detail = message ? `<p class="error-detail">${escapeHtml(message)}</p>` : "";
        errorPanel.innerHTML = `
          <h2 data-i18n-key="errors.loadTitle">${t("errors.loadTitle")}</h2>
          <p data-i18n-key="errors.loadBody">${t("errors.loadBody")}</p>
          ${detail}
          ${troubleshooting}
          ${docsLink}
        `;
        errorPanel.hidden = false;
        errorPanel.setAttribute("data-state", "visible");
        if (alertsRegion) {
          alertsRegion.setAttribute("hidden", "true");
          alertsRegion.innerHTML = "";
        }
        if (mainContent) {
          mainContent.setAttribute("hidden", "true");
          mainContent.setAttribute("aria-hidden", "true");
        }
      };

      const DEFAULT_MANIFEST = {
        global: {
          treasury: "0x0000000000000000000000000000000000000000",
          universalVault: "0x0000000000000000000000000000000000000000",
          upgradeCoordinator: "0x0000000000000000000000000000000000000000",
          validatorRegistry: "0x0000000000000000000000000000000000000000",
          missionControl: "0x0000000000000000000000000000000000000000",
          knowledgeGraph: "0x0000000000000000000000000000000000000000",
          guardianCouncil: "0x0000000000000000000000000000000000000000",
          systemPause: "0x0000000000000000000000000000000000000000",
          heartbeatSeconds: 600,
          guardianReviewWindow: 600,
          maxDrawdownBps: 0,
          manifestoURI: "—",
        },
        domains: [],
        sentinels: [],
        capitalStreams: [],
        selfImprovement: {
          plan: null,
          playbooks: [],
          autonomyGuards: {
            maxAutonomyBps: 0,
            humanOverrideMinutes: 0,
            pausable: false,
            escalationChannels: [],
          },
        },
      };

      const cloneManifest = (value) => JSON.parse(JSON.stringify(value ?? {}));

      const manifestStatusNode = document.querySelector("[data-manifest-status]");
      const manifestFeedbackNode = document.querySelector("[data-manifest-feedback]");
      const manifestUploadInput = document.querySelector("[data-test-id=\"manifest-upload-input\"]");
      const manifestResetButton = document.getElementById("manifest-reset");
      const manifestRefreshButton = document.getElementById("manifest-refresh");
      const manifestUrlForm = document.getElementById("manifest-url-form");
      const manifestUrlInput = document.getElementById("manifest-url-input");

      let defaultManifest = null;
      let defaultManifestSource = null;
      let currentManifest = null;
      let currentSource = null;

      const setManifestFeedback = (message, tone = "info") => {
        if (!manifestFeedbackNode) return;
        const content = String(message ?? "").trim();
        if (!content) {
          manifestFeedbackNode.textContent = "";
          manifestFeedbackNode.setAttribute("data-visible", "false");
          manifestFeedbackNode.removeAttribute("data-tone");
          return;
        }
        manifestFeedbackNode.textContent = content;
        manifestFeedbackNode.setAttribute("data-visible", "true");
        manifestFeedbackNode.setAttribute("data-tone", tone);
      };

      const formatStatusMessage = (template, replacements) => {
        let output = template;
        for (const [key, value] of Object.entries(replacements ?? {})) {
          output = output.replace(new RegExp(`\\{${key}\\}`, "g"), value ?? "");
        }
        return output;
      };

      const setManifestStatus = (source) => {
        if (!manifestStatusNode) return;
        const normalized = source ? { ...source } : { type: "custom" };
        const type = normalized.type ?? "custom";
        const template = t(`manifestConsole.status.${type}`) || t("manifestConsole.status.custom");
        const replacements = {
          path: normalized.label ?? normalized.path ?? "config/universal.value.manifest.json",
          url: normalized.href ?? normalized.label ?? "",
          name: normalized.name ?? normalized.label ?? "manifest.json",
        };
        manifestStatusNode.textContent = formatStatusMessage(template, replacements);
        manifestStatusNode.setAttribute("data-status", type);
      };

      const RUNBOOK_STEPS = [
        {
          key: "install",
          text: t("runbook.steps.install.text"),
          code: "npm ci",
          tooltip: t("runbook.steps.install.tooltip"),
          copyLabel: TEXT.runbook.steps.install.copyLabel,
        },
        {
          key: "orchestrate",
          text: t("runbook.steps.orchestrate.text"),
          code: "npm run demo:phase8:orchestrate",
          tooltip: t("runbook.steps.orchestrate.tooltip"),
          copyLabel: TEXT.runbook.steps.orchestrate.copyLabel,
          download: {
            href: "./output/phase8-orchestration-report.txt",
            label: t("runbook.steps.orchestrate.downloadLabel"),
          },
        },
        {
          key: "apply",
          text: t("runbook.steps.apply.text"),
          tooltip: t("runbook.steps.apply.tooltip"),
        },
        {
          key: "plan",
          text: t("runbook.steps.plan.text"),
          code: "setSelfImprovementPlan",
          tooltip: t("runbook.steps.plan.tooltip"),
          copyLabel: TEXT.runbook.steps.plan.copyLabel,
          download: {
            href: "./output/phase8-self-improvement-plan.json",
            label: t("runbook.steps.plan.downloadLabel"),
          },
        },
        {
          key: "record",
          text: t("runbook.steps.record.text"),
          code: "recordSelfImprovementExecution",
          tooltip: t("runbook.steps.record.tooltip"),
          copyLabel: TEXT.runbook.steps.record.copyLabel,
          download: {
            href: "./output/phase8-cycle-report.csv",
            label: t("runbook.steps.record.downloadLabel"),
          },
        },
        {
          key: "telemetry",
          text: t("runbook.steps.telemetry.text"),
          tooltip: t("runbook.steps.telemetry.tooltip"),
        },
        {
          key: "trigger",
          text: t("runbook.steps.trigger.text"),
          tooltip: t("runbook.steps.trigger.tooltip"),
        },
      ];

      const SECTION_SCHEMA = [
        { target: "#stats", renderer: renderStats },
        { target: "#controls", renderer: renderControls },
        { target: "#domains", renderer: renderDomains },
        { target: "#sentinels", renderer: renderSentinels },
        { target: "#streams", renderer: renderStreams },
        { target: "#playbooks", renderer: renderPlaybooks },
        { target: "#runbook", renderer: renderRunbook },
        { target: "#mermaid-diagram", renderer: renderMermaid },
      ];

      const asArray = (value) => (Array.isArray(value) ? value : []);

      const applyDefaults = (source, defaults) => {
        if (Array.isArray(source)) return source;
        if (Array.isArray(defaults)) return Array.isArray(source) ? source : defaults;
        if (source && typeof source === "object") {
          const result = { ...(defaults || {}) };
          for (const [key, val] of Object.entries(source)) {
            result[key] = applyDefaults(val, defaults ? defaults[key] : undefined);
          }
          return result;
        }
        return source ?? defaults;
      };

      const toNumber = (value, fallback = 0) => {
        const num = Number(value);
        return Number.isFinite(num) ? num : fallback;
      };

      const shortAddress = (value) => {
        if (!value) return "—";
        const addr = String(value);
        if (addr.length <= 10) return addr;
        return `${addr.slice(0, 6)}…${addr.slice(-4)}`;
      };

      const formatUSD = (value) => {
        const amount = toNumber(value, 0);
        const abs = Math.abs(amount);
        if (abs >= 1e12) return `$${(amount / 1e12).toFixed(2)}T`;
        if (abs >= 1e9) return `$${(amount / 1e9).toFixed(2)}B`;
        if (abs >= 1e6) return `$${(amount / 1e6).toFixed(2)}M`;
        return `$${amount.toLocaleString("en-US", { maximumFractionDigits: 0 })}`;
      };

      const formatAmount = (value) => {
        try {
          if (value === null || value === undefined) return "0";
          const big = BigInt(value);
          if (big === BigInt(0)) return "0";
          const abs = big < 0 ? -big : big;
          const str = abs.toString();
          if (str.length <= 6) return big.toString();
          return `${big < 0 ? "-" : ""}${str.slice(0, 3)}… (10^${str.length - 3})`;
        } catch (error) {
          return String(value ?? "0");
        }
      };

      const formatDuration = (seconds) => {
        const value = toNumber(seconds, 0);
        if (value <= 0) return "0 s";
        if (value >= 3600) return `${(value / 3600).toFixed(2)} h`;
        if (value >= 60) return `${(value / 60).toFixed(1)} min`;
        return `${value.toFixed(0)} s`;
      };

      const formatSeconds = (seconds) => `${toNumber(seconds, 0).toLocaleString()} s`;

      const formatTimestamp = (seconds) => {
        const value = toNumber(seconds, 0);
        if (!value) return "—";
        return `${dateFormatter.format(new Date(value * 1000))} UTC`;
      };

      const computeDominanceScore = (input) => {
        const valueScore = input.totalMonthlyUSD <= 0 ? 0 : Math.min(1, input.totalMonthlyUSD / 500_000_000_000);
        const resilienceScore = Math.max(0, Math.min(1, input.averageResilience));
        const coverageRatioScore = input.coverageRatio <= 0 ? 0 : Math.min(1, input.coverageRatio);
        const coverageStrengthScore =
          input.guardianReviewWindowSeconds > 0
            ? Math.min(1, input.averageDomainCoverageSeconds / input.guardianReviewWindowSeconds)
            : 1;
        const coverageScore = Math.min(1, (coverageRatioScore + coverageStrengthScore) / 2);
        const autonomyScore =
          input.autonomyGuardCapBps > 0 ? Math.min(1, input.maxAutonomyBps / input.autonomyGuardCapBps) : 1;
        const cadenceScore =
          input.cadenceSeconds > 0
            ? Math.max(0, 1 - Math.min(1, input.cadenceSeconds / (24 * 60 * 60)))
            : 0.5;
        const weighted =
          0.3 * valueScore + 0.25 * resilienceScore + 0.2 * coverageScore + 0.15 * autonomyScore + 0.1 * cadenceScore;
        return Math.min(100, Math.round(weighted * 1000) / 10);
      };

      const renderAlerts = (alerts) => {
        const container = document.getElementById("alerts");
        if (!container) return;
        if (!alerts.length) {
          container.innerHTML = "";
          container.setAttribute("hidden", "true");
          return;
        }
        container.removeAttribute("hidden");
        container.innerHTML = alerts
          .map(
            (alert, index) => `
              <div class="alert" role="alert" data-level="${alert.level}" data-test-id="alert">
                <strong id="alert-${index}">${alert.title}</strong>
                <p aria-describedby="alert-${index}">${alert.description}</p>
              </div>
            `,
          )
          .join("");
      };

      const buildContext = (manifest) => {
        const domains = asArray(manifest.domains);
        const sentinels = asArray(manifest.sentinels);
        const streams = asArray(manifest.capitalStreams);
        const domainSlugs = domains.map((domain) => String(domain.slug ?? ""));

        const coverageMap = new Map();
        const fundingMap = new Map();
        const streamBindings = new Map();
        const defaultTargets = domainSlugs.length ? domainSlugs : ["*"];
        for (const sentinel of sentinels) {
          const coverageSeconds = toNumber(sentinel.coverageSeconds, 0);
          const targets = asArray(sentinel.domains).length ? asArray(sentinel.domains) : defaultTargets;
          for (const target of targets) {
            const normalized = String(target || "").toLowerCase();
            coverageMap.set(normalized, (coverageMap.get(normalized) || 0) + coverageSeconds);
          }
        }
        for (const stream of streams) {
          const budget = toNumber(stream.annualBudget, 0);
          if (!Number.isFinite(budget) || budget <= 0) continue;
          const streamName = stream.name || stream.slug || "Stream";
          const targets = asArray(stream.domains).length ? asArray(stream.domains) : defaultTargets;
          for (const target of targets) {
            const normalized = String(target || "").toLowerCase();
            if (!normalized) continue;
            fundingMap.set(normalized, (fundingMap.get(normalized) || 0) + budget);
            const list = streamBindings.get(normalized) || [];
            if (!list.includes(streamName)) {
              list.push(streamName);
              streamBindings.set(normalized, list);
            }
          }
        }

        const totalMonthly = domains.reduce((acc, domain) => acc + toNumber(domain.valueFlowMonthlyUSD, 0), 0);
        const annualBudget = streams.reduce((acc, stream) => acc + toNumber(stream.annualBudget, 0), 0);
        const averageResilience = domains.length
          ? domains.reduce((acc, domain) => acc + toNumber(domain.resilienceIndex, 0), 0) / domains.length
          : 0;
        let totalCoverageSeconds = 0;
        let coveredDomains = 0;
        let fundedDomains = 0;
        let minFundingUSD = domains.length ? Number.POSITIVE_INFINITY : 0;
        for (const domain of domains) {
          const key = String(domain.slug ?? "").toLowerCase();
          const coverageSeconds = coverageMap.get(key) || 0;
          const fundingUSD = fundingMap.get(key) || 0;
          totalCoverageSeconds += coverageSeconds;
          if (coverageSeconds > 0) {
            coveredDomains += 1;
          }
          if (fundingUSD > 0) {
            fundedDomains += 1;
          }
          if (fundingUSD < minFundingUSD) {
            minFundingUSD = fundingUSD;
          }
        }
        const averageCoverageSeconds = domains.length ? totalCoverageSeconds / domains.length : 0;
        const guardianWindowSeconds = toNumber(manifest.global?.guardianReviewWindow, 0);
        const maxAutonomy = domains.reduce((acc, domain) => Math.max(acc, toNumber(domain.autonomyLevelBps, 0)), 0);
        const autonomyCap = toNumber(manifest.selfImprovement?.autonomyGuards?.maxAutonomyBps, 0);
        const cadenceSeconds = toNumber(manifest.selfImprovement?.plan?.cadenceSeconds, 0);
        const dominanceScore = computeDominanceScore({
          totalMonthlyUSD: totalMonthly,
          averageResilience,
          coverageRatio: domains.length ? coveredDomains / domains.length : 0,
          averageDomainCoverageSeconds: averageCoverageSeconds,
          guardianReviewWindowSeconds: guardianWindowSeconds,
          maxAutonomyBps: maxAutonomy,
          autonomyGuardCapBps: autonomyCap,
          cadenceSeconds,
        });

        const uncoveredDomains = domains.filter(
          (domain) => !(coverageMap.get(String(domain.slug ?? "").toLowerCase()) > 0),
        );
        const unfundedDomains = domains.filter(
          (domain) => !(fundingMap.get(String(domain.slug ?? "").toLowerCase()) > 0),
        );

        const alerts = [];
        if (!domains.length) {
          alerts.push({
            level: "critical",
            title: "No domains configured",
            description: "Add at least one dominion to the manifest so capital streams and sentinels can be orchestrated.",
          });
        }
        if (uncoveredDomains.length) {
          alerts.push({
            level: "warning",
            title: "Domains missing sentinel coverage",
            description: `Assign sentinel guardians to: ${uncoveredDomains.map((d) => d.name || d.slug).join(", " )}.`,
          });
        }
        if (unfundedDomains.length) {
          alerts.push({
            level: "warning",
            title: "Domains missing capital coverage",
            description: `Attach capital streams to: ${unfundedDomains.map((d) => d.name || d.slug).join(", " )}.`,
          });
        }
        if (domains.length && guardianWindowSeconds && averageCoverageSeconds < guardianWindowSeconds) {
          alerts.push({
            level: "warning",
            title: "Coverage shortfall detected",
            description: `Average sentinel coverage (${formatDuration(averageCoverageSeconds)}) is below the guardian review window (${formatDuration(
              guardianWindowSeconds,
            )}). Schedule additional sentinels or expand coverage windows.`,
          });
        }
        if (dominanceScore >= 95) {
          alerts.push({
            level: "success",
            title: "Universal dominance secured",
            description: `Dominance score ${dominanceScore.toFixed(1)} / 100 with sentinel coverage ${formatDuration(
              averageCoverageSeconds,
            )} per dominion. Maintain guardian oversight windows to keep the lattice green.`,
          });
        } else if (domains.length && dominanceScore < 85) {
          alerts.push({
            level: "warning",
            title: "Dominance score below target",
            description: `Dominance score ${dominanceScore.toFixed(1)} / 100 — review autonomy caps, sentinel cadence, and domain resilience.`,
          });
        }

        return {
          coverageMap,
          fundingMap,
          streamBindings,
          uncoveredDomains,
          unfundedDomains,
          totals: {
            totalMonthly,
            annualBudget,
            averageResilience,
            totalCoverageSeconds,
            averageCoverageSeconds,
            guardianWindowSeconds,
            dominanceScore,
            coverageRatio: domains.length ? coveredDomains / domains.length : 0,
            fundingRatio: domains.length ? fundedDomains / domains.length : 0,
            maxAutonomy,
            autonomyCap,
            cadenceSeconds,
            minDomainFundingUSD: Number.isFinite(minFundingUSD) ? minFundingUSD : 0,
          },
          alerts,
        };
      };

      function renderManifest(manifest) {
        clearErrorState();
        const context = buildContext(manifest);
        renderAlerts(context.alerts);
        for (const section of SECTION_SCHEMA) {
          const node = document.querySelector(section.target);
          if (!node) continue;
          section.renderer(node, manifest, context);
        }
      }

      function applyManifest(manifest, source, options = {}) {
        const normalized = applyDefaults(cloneManifest(manifest), DEFAULT_MANIFEST);
        currentManifest = cloneManifest(normalized);
        const normalizedSource = { ...(source ?? {}), type: source?.type ?? "custom" };
        currentSource = normalizedSource;
        renderManifest(normalized);
        setManifestStatus(normalizedSource);
        if (options.storeAsDefault) {
          defaultManifest = cloneManifest(normalized);
          defaultManifestSource = { ...normalizedSource };
        }
        const feedback = options.feedback ?? "";
        if (feedback) {
          setManifestFeedback(feedback, options.feedbackTone ?? "success");
        } else {
          setManifestFeedback("");
        }
        return normalized;
      }

      async function fetchManifestFromUrl(href) {
        const response = await fetch(href, { cache: "no-cache" });
        if (!response.ok) {
          const error = new Error(`Failed to load manifest: ${response.status}`);
          error.name = "FetchError";
          throw error;
        }
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (cause) {
          const error = new Error("Invalid manifest JSON");
          error.name = "ParseError";
          error.cause = cause;
          throw error;
        }
      }

      async function loadManifestFromUrl(href, options = {}) {
        const {
          sourceType = "url",
          label,
          storeAsDefault = false,
          feedbackKey,
          showErrorsInPanel = false,
        } = options;
        setManifestStatus({ type: "loading" });
        try {
          const data = await fetchManifestFromUrl(href);
          const source = {
            type: sourceType,
            href,
            label: label ?? (sourceType === "default" ? "config/universal.value.manifest.json" : href),
          };
          const feedback = feedbackKey ? t(feedbackKey) : "";
          applyManifest(data, source, {
            storeAsDefault,
            feedback,
            feedbackTone: feedback ? "success" : "info",
          });
          return true;
        } catch (error) {
          console.error(error);
          const messageKey =
            error?.name === "ParseError"
              ? "manifestConsole.feedback.errorInvalidJson"
              : "manifestConsole.feedback.errorFetch";
          const message = t(messageKey);
          if (showErrorsInPanel) {
            showErrorPanel({
              message,
              steps: [t("errors.stepCheckPath"), t("errors.stepRebuild"), t("errors.stepDocs")],
            });
          } else {
            setManifestFeedback(message, "error");
            if (currentSource) {
              setManifestStatus(currentSource);
            } else {
              setManifestStatus({ type: "error" });
            }
          }
          return false;
        }
      }

      async function handleManifestUpload(event) {
        const input = event.currentTarget;
        if (!(input instanceof HTMLInputElement) || !input.files || !input.files.length) return;
        const [file] = input.files;
        try {
          const text = await file.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch (cause) {
            const parseError = new Error("Invalid manifest JSON");
            parseError.name = "ParseError";
            parseError.cause = cause;
            throw parseError;
          }
          applyManifest(
            data,
            { type: "upload", name: file?.name || "manifest.json" },
            {
              feedback: t("manifestConsole.feedback.successUpload"),
              feedbackTone: "success",
            },
          );
        } catch (error) {
          console.error(error);
          const messageKey =
            error?.name === "ParseError"
              ? "manifestConsole.feedback.errorInvalidJson"
              : "manifestConsole.feedback.errorUpload";
          setManifestFeedback(t(messageKey), "error");
          if (currentSource) {
            setManifestStatus(currentSource);
          }
        } finally {
          input.value = "";
        }
      }

      function handleManifestReset() {
        if (defaultManifest && defaultManifestSource) {
          applyManifest(defaultManifest, defaultManifestSource, {
            feedback: t("manifestConsole.feedback.reset"),
            feedbackTone: "success",
          });
        } else {
          loadManifestFromUrl(configPath.href, {
            sourceType: baselineSourceType,
            label: baselineLabel,
            storeAsDefault: true,
            feedbackKey: "manifestConsole.feedback.reset",
          });
        }
      }

      function handleManifestRefresh() {
        loadManifestFromUrl(configPath.href, {
          sourceType: baselineSourceType,
          label: baselineLabel,
          storeAsDefault: true,
          feedbackKey: "manifestConsole.feedback.refresh",
        });
      }

      async function handleManifestUrlSubmit(event) {
        event.preventDefault();
        if (!(manifestUrlInput instanceof HTMLInputElement)) return;
        const raw = manifestUrlInput.value.trim();
        if (!raw) {
          setManifestFeedback(t("manifestConsole.feedback.errorEmptyUrl"), "warning");
          return;
        }
        let resolved;
        try {
          resolved = new URL(raw, window.location.href);
        } catch (error) {
          setManifestFeedback(t("manifestConsole.feedback.errorInvalidUrl"), "error");
          return;
        }
        manifestUrlInput.value = resolved.href;
        await loadManifestFromUrl(resolved.href, {
          sourceType: "url",
          label: resolved.href,
          feedbackKey: "manifestConsole.feedback.successUrl",
        });
      }

      function renderStats(container, manifest, context) {
        const stats = [
          {
            key: "dominance-score",
            label: "Universal dominance score",
            value: `${context.totals.dominanceScore.toFixed(1)} / 100`,
          },
          { key: "monthly-flow", label: "Monthly value flow", value: formatUSD(context.totals.totalMonthly) },
          { key: "annual-budget", label: "Annual capital budget", value: formatUSD(context.totals.annualBudget) },
          { key: "average-resilience", label: "Average resilience", value: context.totals.averageResilience.toFixed(3) },
          {
            key: "sentinel-coverage",
            label: "Sentinel coverage",
            value: `${formatDuration(context.totals.averageCoverageSeconds || 0)} per dominion`,
          },
          {
            key: "capital-coverage",
            label: "Dominions funded",
            value: `${(context.totals.fundingRatio * 100).toFixed(1)}% · floor ${formatUSD(
              context.totals.minDomainFundingUSD || 0,
            )}/yr`,
          },
        ];

        const plan = manifest.selfImprovement?.plan;
        if (plan?.cadenceSeconds) {
          stats.push({
            key: "improvement-cadence",
            label: "Improvement cadence",
            value: formatDuration(plan.cadenceSeconds),
          });
        }
        if (plan?.lastExecutedAt) {
          stats.push({
            key: "last-improvement",
            label: "Last improvement",
            value: formatTimestamp(plan.lastExecutedAt),
          });
        }

        container.innerHTML = stats
          .map(
            (item) => `
              <article class="stat-card" role="listitem" data-test-id="stat-card" data-stat-key="${item.key}">
                <h2>${item.label}</h2>
                <p>${item.value}</p>
              </article>
            `,
          )
          .join("");
      }

      function renderControls(container, manifest) {
        const global = manifest.global || {};
        const controlCards = [
          {
            key: "treasury",
            segments: [
              {
                key: "treasury",
                label: t("controls.treasury"),
                display: shortAddress(global.treasury),
                copyValue: global.treasury,
                type: "address",
              },
              {
                key: "vault",
                label: t("controls.vault"),
                display: shortAddress(global.universalVault),
                copyValue: global.universalVault,
                type: "address",
              },
            ],
          },
          {
            key: "upgrade",
            segments: [
              {
                key: "upgradeCoordinator",
                label: t("controls.upgradeCoordinator"),
                display: shortAddress(global.upgradeCoordinator),
                copyValue: global.upgradeCoordinator,
                type: "address",
              },
              {
                key: "validatorRegistry",
                label: t("controls.validatorRegistry"),
                display: shortAddress(global.validatorRegistry),
                copyValue: global.validatorRegistry,
                type: "address",
              },
            ],
          },
          {
            key: "mission",
            segments: [
              {
                key: "missionControl",
                label: t("controls.missionControl"),
                display: shortAddress(global.missionControl),
                copyValue: global.missionControl,
                type: "address",
              },
              {
                key: "knowledgeGraph",
                label: t("controls.knowledgeGraph"),
                display: shortAddress(global.knowledgeGraph),
                copyValue: global.knowledgeGraph,
                type: "address",
              },
            ],
          },
          {
            key: "guardian",
            segments: [
              {
                key: "guardianCouncil",
                label: t("controls.guardianCouncil"),
                display: shortAddress(global.guardianCouncil),
                copyValue: global.guardianCouncil,
                type: "address",
              },
              {
                key: "systemPause",
                label: t("controls.systemPause"),
                display: shortAddress(global.systemPause),
                copyValue: global.systemPause,
                type: "address",
              },
            ],
          },
          {
            key: "manifest",
            segments: [
              {
                key: "manifest",
                label: t("controls.manifest"),
                display: global.manifestoURI || t("fallbacks.missingManifest"),
                copyValue: global.manifestoURI || "",
                type: global.manifestoURI ? "uri" : undefined,
              },
              {
                key: "drawdown",
                label: t("controls.drawdown"),
                display: `${toNumber(global.maxDrawdownBps, 0)} bps`,
              },
            ],
          },
        ];

        const renderSegment = (segment) => {
          const display = segment.display ?? segment.copyValue ?? "—";
          const payload = segment.copyValue && segment.copyValue !== "—" ? segment.copyValue : "";
          const feedbackId = `control-${segment.key}`;
          const ariaLabel = t("copy.controlAria").replace("{label}", segment.label);
          const copyMarkup = payload
            ? `
                <div class="copy-controls">
                  ${copyButtonMarkup(payload, {
                    ariaLabel,
                    feedbackId,
                    testId: segment.type === "address" ? "copy-address" : "copy-control",
                    copyLabel: segment.label,
                    type: segment.type || "value",
                  })}
                  <span class="copy-feedback" data-feedback-for="${feedbackId}" data-test-id="copy-feedback" role="status" aria-live="polite"></span>
                </div>
              `
            : "";
          return `
            <div class="control-value" data-control-segment="${segment.key}">
              <strong class="control-label" data-i18n-key="controls.${segment.key}">${segment.label}</strong>
              <div class="control-value-inner">
                <span class="control-value-text">${escapeHtml(display)}</span>
                ${copyMarkup}
              </div>
            </div>
          `;
        };

        container.innerHTML = controlCards
          .map(
            (entry, index) => `
              <article class="sentinel-item control-card" data-test-id="control-card" data-control-index="${index}">
                ${entry.segments.map(renderSegment).join("")}
              </article>
            `,
          )
          .join("");
      }

      function renderDomains(container, manifest, context) {
        const domains = asArray(manifest.domains);
        if (!domains.length) {
          container.innerHTML = `<p data-i18n-key="fallbacks.noDominions">${t("fallbacks.noDominions")}</p>`;
          return;
        }

        container.innerHTML = domains
          .map((domain) => {
            const tags = asArray(domain.skillTags)
              .map((tag) => `<span class="chip">${tag}</span>`)
              .join(" ");
            const slugKey = String(domain.slug ?? "").toLowerCase();
            const covered = context.coverageMap.get(slugKey);
            const fundingUSD = context.fundingMap.get(slugKey) || 0;
            const streamNames = context.streamBindings.get(slugKey) || [];
            const classNames = ["domain-card"];
            if (!covered) classNames.push("no-coverage");
            if (!fundingUSD) classNames.push("no-funding");
            const streams = streamNames
              .map((stream) => `<span class="chip alt" data-test-id="domain-stream">${stream}</span>`)
              .join(" ");
            const warnings = [];
            if (!fundingUSD) warnings.push(t("fallbacks.coverageRequired"));
            const warningMarkup = warnings.length
              ? `<div class="domain-warnings">${warnings
                  .map((warning) => `<span class="chip warning">${warning}</span>`)
                  .join(" ")}</div>`
              : "";
            return `
              <article class="${classNames.join(" ")}" data-test-id="domain-card" data-domain-slug="${domain.slug}">
                <h3>${domain.name || domain.slug}</h3>
                <p>${domain.autonomyNarrative || t("fallbacks.autonomyPending")}</p>
                <div class="domain-meta">
                  <span class="chip">ID ${domain.slug || "n/a"}</span>
                  <span class="chip">Autonomy ${toNumber(domain.autonomyLevelBps, 0)} bps</span>
                  <span class="chip">Resilience ${(toNumber(domain.resilienceIndex, 0)).toFixed(3)}</span>
                  <span class="chip">TVL ≤ ${formatAmount(domain.tvlLimit)}</span>
                  <span class="chip">Heartbeat ${formatSeconds(domain.heartbeatSeconds)}</span>
                  <span class="chip alt">Funding ${formatUSD(fundingUSD)}/yr</span>
                </div>
                <div class="domain-meta">${tags}</div>
                ${streams ? `<div class="domain-meta">${streams}</div>` : ""}
                ${warningMarkup}
              </article>
            `;
          })
          .join("");
      }

      function renderSentinels(container, manifest) {
        const sentinels = asArray(manifest.sentinels);
        if (!sentinels.length) {
          container.innerHTML = `<p data-i18n-key="fallbacks.noSentinels">${t("fallbacks.noSentinels")}</p>`;
          return;
        }

        container.innerHTML = sentinels
          .map(
            (sentinel) => `
              <article class="sentinel-item" data-test-id="sentinel-card" data-sentinel-slug="${sentinel.slug}">
                <strong>${sentinel.name || sentinel.slug}</strong>
                <p>Coverage ${formatDuration(sentinel.coverageSeconds)} · Sensitivity ${toNumber(sentinel.sensitivityBps, 0)} bps · Domains ${
                  asArray(sentinel.domains).join(" · ") || "—"
                }</p>
                <p>Agent ${shortAddress(sentinel.agent)} · Policy ${sentinel.uri || "—"}</p>
              </article>
            `,
          )
          .join("");
      }

      function renderStreams(container, manifest) {
        const streams = asArray(manifest.capitalStreams);
        if (!streams.length) {
          container.innerHTML = `<p data-i18n-key="fallbacks.noStreams">${t("fallbacks.noStreams")}</p>`;
          return;
        }

        container.innerHTML = streams
          .map(
            (stream) => `
              <article class="stream-item" data-test-id="stream-card" data-stream-slug="${stream.slug}">
                <strong>${stream.name || stream.slug}</strong>
                <p>${formatUSD(stream.annualBudget)}/yr · Expansion ${toNumber(stream.expansionBps, 0)} bps · Domains ${
                  asArray(stream.domains).join(" · ") || "—"
                }</p>
                <p>Vault ${shortAddress(stream.vault)} · Manifest ${stream.uri || "—"}</p>
              </article>
            `,
          )
          .join("");
      }

      function renderPlaybooks(container, manifest) {
        const entries = [];
        const plan = manifest.selfImprovement?.plan;
        if (plan && (plan.planURI || plan.planHash || plan.cadenceSeconds || plan.lastExecutedAt)) {
          entries.push(`
            <article class="playbook-item" data-test-id="playbook-card" data-playbook-type="plan">
              <strong>Strategic plan</strong>
              <p>Cadence ${formatDuration(plan.cadenceSeconds)} · Hash ${plan.planHash || "—"}</p>
              <p>Manifest ${plan.planURI || "—"}${
                plan.lastExecutedAt ? ` · Last execution ${formatTimestamp(plan.lastExecutedAt)}` : ""
              }</p>
              <p>Latest report ${plan.lastReportURI || "—"}</p>
            </article>
          `);
        }

        for (const playbook of asArray(manifest.selfImprovement?.playbooks)) {
          entries.push(`
            <article class="playbook-item" data-test-id="playbook-card" data-playbook-name="${playbook.name}">
              <strong>${playbook.name}</strong>
              <p>${playbook.description || t("fallbacks.playbookPending")}</p>
              <p>Owner ${shortAddress(playbook.owner)} · Automation ${playbook.automation || "manual"} · Guardrails ${
                asArray(playbook.guardrails).join(" · ") || "—"
              }</p>
            </article>
          `);
        }

        const guards = manifest.selfImprovement?.autonomyGuards || {};
        entries.push(`
          <article class="playbook-item" data-test-id="playbook-card" data-playbook-type="guard">
            <strong>Autonomy guard</strong>
            <p>≤${toNumber(guards.maxAutonomyBps, 0)} bps · Override window ${toNumber(guards.humanOverrideMinutes, 0)} minutes · Pausable ${
              guards.pausable ? "yes" : "no"
            }</p>
            <p>Escalation ${asArray(guards.escalationChannels).join(" → ") || "—"}</p>
          </article>
        `);

        container.innerHTML = entries.join("");
      }

      function renderRunbook(container) {
        container.innerHTML = RUNBOOK_STEPS.map((step, index) => {
          const tooltipId = `runbook-tooltip-${index}`;
          const tooltipLabel = t("runbook.tooltipAria").replace("{step}", index + 1);
          const tooltipControls = step.tooltip
            ? `
              <button
                type="button"
                class="info-button"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="${tooltipId}"
                aria-label="${escapeHtml(tooltipLabel)}"
              >ℹ️</button>
              <span class="tooltip" role="tooltip" id="${tooltipId}" data-i18n-key="runbook.steps.${step.key}.tooltip">${
                step.tooltip
              }</span>
            `
            : "";
          const hasCode = Boolean(step.code);
          const feedbackId = `runbook-${index}`;
          const commandAria = t("copy.commandAria").replace("{step}", index + 1);
          const code = hasCode
            ? `
              <div class="command-row" data-test-id="runbook-command">
                <code>${escapeHtml(step.code)}</code>
                <div class="copy-controls">
                  ${copyButtonMarkup(step.code, {
                    ariaLabel: commandAria,
                    feedbackId,
                    testId: "copy-command",
                    copyLabel: step.copyLabel || step.text,
                    type: "runbook",
                  })}
                  <span class="copy-feedback" data-feedback-for="${feedbackId}" data-test-id="copy-feedback" role="status" aria-live="polite"></span>
                </div>
              </div>
            `
            : "";
          const download = step.download
            ? `<a class="download-link" href="${step.download.href}" download data-test-id="runbook-download" data-i18n-key="runbook.steps.${step.key}.download">${step.download.label}</a>`
            : "";
          return `
            <li class="runbook-step" data-test-id="runbook-step" data-has-code="${hasCode}" data-runbook-key="${step.key}">
              <div class="runbook-step-header">
                <span class="step-text" data-i18n-key="runbook.steps.${step.key}.text">${step.text}</span>
                ${tooltipControls}
              </div>
              ${code}
              ${download}
            </li>
          `;
        }).join("");
      }

      function renderMermaid(container, manifest) {
        const lines = [
          "graph TD",
          "  Governance[[Guardian Council]] --> Manager(Phase8UniversalValueManager)",
          "  Manager --> Treasury[[Universal Treasury]]",
          "  Manager --> Pause[System Pause Controller]",
          "  Manager --> Streams[[Capital Streams]]",
        ];

        asArray(manifest.domains).forEach((domain, index) => {
          const id = String(domain.slug || `domain${index}`).replace(/[^a-z0-9]/gi, "").toLowerCase() || `domain${index}`;
          lines.push(`  Manager --> ${id}([${domain.name || domain.slug || "Domain"}])`);
        });

        asArray(manifest.sentinels).forEach((sentinel, index) => {
          const baseId = String(sentinel.slug || `sentinel${index}`).replace(/[^a-z0-9]/gi, "").toLowerCase() || `sentinel${index}`;
          lines.push(`  ${baseId}Sentinel{${sentinel.name || sentinel.slug || "Sentinel"}} --> Pause`);
          asArray(sentinel.domains).forEach((domain) => {
            const domainId = String(domain || "domain").replace(/[^a-z0-9]/gi, "").toLowerCase();
            if (domainId) {
              lines.push(`  ${baseId}Sentinel --> ${domainId}`);
            }
          });
        });

        asArray(manifest.capitalStreams).forEach((stream, index) => {
          const streamId = String(stream.slug || `stream${index}`).replace(/[^a-z0-9]/gi, "").toLowerCase() || `stream${index}`;
          lines.push(`  Streams --> ${streamId}Stream[[${stream.name || stream.slug || "Stream"}]]`);
          asArray(stream.domains).forEach((domain) => {
            const domainId = String(domain || "domain").replace(/[^a-z0-9]/gi, "").toLowerCase();
            if (domainId) {
              lines.push(`  ${streamId}Stream --> ${domainId}`);
            }
          });
        });

        const diagramText = lines.join("\n");
        container.textContent = diagramText;

        const mermaidWrapper = document.querySelector('[data-role="mermaid-controls"]');
        const mermaidControls = document.querySelector('[data-role="mermaid-copy-controls"]');
        const mermaidFeedback = document.querySelector('.copy-feedback[data-feedback-for="mermaid-diagram"]');

        if (mermaidWrapper && mermaidControls) {
          const existingButton = mermaidControls.querySelector('.copy-button');
          if (existingButton && copyButtonTimers.has(existingButton)) {
            window.clearTimeout(copyButtonTimers.get(existingButton));
            copyButtonTimers.delete(existingButton);
          }
          const buttonMarkup = copyButtonMarkup(diagramText, {
            ariaLabel: t("copy.diagramAria"),
            feedbackId: "mermaid-diagram",
            testId: "copy-mermaid",
            copyLabel: t("copy.diagramLabel"),
            type: "mermaid",
          });
          mermaidControls.innerHTML = buttonMarkup;
          mermaidWrapper.setAttribute("data-visible", buttonMarkup ? "true" : "false");
          if (mermaidFeedback) {
            mermaidFeedback.textContent = "";
            mermaidFeedback.removeAttribute("data-visible");
          }
        }

        const markFallback = (error) => {
          container.setAttribute("data-rendered", "fallback");
          container.setAttribute("aria-label", t("mermaid.fallback"));
          container.textContent = `${t("mermaid.fallback")}\n${diagramText}`;
          if (error) {
            console.warn("Rendering mermaid fallback", error);
          }
        };

        if (window.mermaid) {
          try {
            container.setAttribute("data-rendered", "pending");
            window.mermaid.initialize({ startOnLoad: false, theme: "dark" });
            Promise.resolve(window.mermaid.run({ nodes: [container] }))
              .then(() => container.setAttribute("data-rendered", "true"))
              .catch((error) => {
                markFallback(error);
              });
          } catch (error) {
            markFallback(error);
          }
        } else {
          markFallback();
        }
      }

      if (manifestUploadInput instanceof HTMLInputElement) {
        manifestUploadInput.addEventListener('change', handleManifestUpload);
      }
      if (manifestResetButton instanceof HTMLElement) {
        manifestResetButton.addEventListener('click', handleManifestReset);
      }
      if (manifestRefreshButton instanceof HTMLElement) {
        manifestRefreshButton.addEventListener('click', handleManifestRefresh);
      }
      if (manifestUrlForm instanceof HTMLFormElement) {
        manifestUrlForm.addEventListener('submit', handleManifestUrlSubmit);
      }

      document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;

        const copyButton = target.closest('.copy-button');
        if (copyButton) {
          event.preventDefault();
          handleCopy(copyButton);
          return;
        }

        const infoButton = target.closest('.info-button');
        if (infoButton) {
          event.preventDefault();
          const expanded = infoButton.getAttribute('aria-expanded') === 'true';
          hideAllTooltips(infoButton);
          toggleTooltip(infoButton, !expanded);
          return;
        }

        if (!target.closest('.tooltip')) {
          hideAllTooltips();
        }
      });

      document.addEventListener('focusin', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const infoButton = target.closest('.info-button');
        if (infoButton) {
          hideAllTooltips(infoButton);
          toggleTooltip(infoButton, true);
        }
      });

      document.addEventListener('focusout', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const infoButton = target.closest('.info-button');
        if (infoButton) {
          window.setTimeout(() => {
            if (document.activeElement && infoButton.contains(document.activeElement)) return;
            toggleTooltip(infoButton, false);
          }, 0);
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hideAllTooltips();
        }
      });

      const initialFeedbackKey =
        baselineSourceType === "param" ? "manifestConsole.feedback.paramOverride" : undefined;
      loadManifestFromUrl(configPath.href, {
        sourceType: baselineSourceType,
        label: baselineLabel,
        storeAsDefault: true,
        feedbackKey: initialFeedbackKey,
        showErrorsInPanel: true,
      });
    </script>
  </body>
</html>
