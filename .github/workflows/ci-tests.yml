---
# yamllint disable rule:truthy
name: ci (modular) / tests

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: read

concurrency:
  group: ci-tests-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a  # yamllint disable-line rule:line-length
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # yamllint disable-line rule:line-length
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # yamllint disable-line rule:line-length
        with:
          node-version-file: '.nvmrc'
          cache: npm
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json
      - name: Cache Hardhat compilers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # yamllint disable-line rule:line-length
        with:
          path: ~/.cache/hardhat-nodejs
          key: hardhat-${{ runner.os }}-${{ hashFiles('hardhat.config.js', 'package-lock.json') }}  # yamllint disable-line rule:line-length
          restore-keys: |
            hardhat-${{ runner.os }}-
      - name: Preflight toolchain locks
        run: npm run ci:preflight
      - name: Install dependencies
        run: ./scripts/ci/npm-ci.sh --no-audit --prefer-offline --progress=false
      - name: Compile contracts
        run: |
          npx ts-node \
            --compiler-options '{"module":"commonjs"}' \
            scripts/generate-constants.ts
          npx hardhat compile
      - name: Regenerate constants for tests
        run: |
          npx ts-node \
            --compiler-options '{"module":"commonjs"}' \
            scripts/generate-constants.ts
      - name: Hardhat tests
        run: npm test
      - name: ABI diff check
        run: npm run abi:diff
